SET SERVEROUTPUT OFF;

DECLARE
    v_feed_id NUMBER := ###;
    
    type r_loc is record
    (
	location_mapping_id NUMBER
    );
    type t_locs is table of r_loc index by pls_integer;
    v_locs t_locs;
    
    type r_range is record
    (
	location_mapping_range_id NUMBER
    );
    type t_ranges is table of r_range index by pls_integer;
    v_ranges t_ranges;

BEGIN

    SELECT DISTINCT
	lm.location_mapping_id
    BULK COLLECT INTO v_locs
    FROM adt.location_mapping lm
    where lm.feed_id = v_feed_id
    and upper(trim (both from lm.mapping_value)) IN
    (
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?,
	?
    )
    ;

    IF v_locs.COUNT > # THEN

	FOR i in v_locs.FIRST .. v_locs.LAST
	LOOP

	    -- Get ranges for location_mapping_id:
	    SELECT DISTINCT
		lmr.location_mapping_range_id
	    BULK COLLECT INTO v_ranges
	    FROM adt.location_mapping_range lmr
	    where lmr.feed_id = v_feed_id
	    and lmr.location_mapping_id = v_locs(i).location_mapping_id
	    ;

	    -- Loop through and remove associated ranges first otherwise constraint violation encountered:
	    IF v_ranges.COUNT > # THEN

		FOR j in v_ranges.FIRST .. v_ranges.LAST 
		LOOP 

		    DELETE FROM adt.location_mapping_range lmr
		    WHERE lmr.feed_id = v_feed_id
		    and lmr.location_mapping_range_id = v_ranges(j).location_mapping_range_id
		    AND lmr.location_mapping_id = v_locs(i).location_mapping_id;

		    COMMIT;
    
		END LOOP;

	    END IF;

	    -- Remove the location_mapping record last to avoid constraint violation:
	    DELETE FROM adt.location_mapping lm
	    WHERE lm.feed_id = v_feed_id
	    AND lm.location_mapping_id = v_locs(i).location_mapping_id
	    ;
	    
	    COMMIT;

	END LOOP;

    END IF;

END;
/
